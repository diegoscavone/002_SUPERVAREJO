# üõ°Ô∏è Documenta√ß√£o T√©cnica - Ecossistema SuperVarejo

Esta documenta√ß√£o detalha a infraestrutura de containers, rede e banco de dados do projeto, servindo como guia de recupera√ß√£o em caso de falhas ou renova√ß√£o de certificados.

---

## üöÄ 1. Estrutura de Rede e Funcionamento
O sistema opera em uma arquitetura h√≠brida de containers Docker e servi√ßos locais:

* **Frontend (web):** Container em modo `bridge` servindo os arquivos est√°ticos.
* **API Principal (api):** Container em modo `bridge` conectado ao banco de dados interno do Docker (`db`).
* **API ERP (api-erp):** Container em modo **`host`**. Ele compartilha o IP do servidor Linux para acessar o banco de dados PostgreSQL local via `127.0.0.1`.
* **Nginx Proxy Manager (NPM):** Gerencia o SSL e distribui o tr√°fego para os containers acima.

---

## üîê 2. Gest√£o de Certificados SSL (Let's Encrypt)
Os certificados s√£o renovados automaticamente pelo NPM 30 dias antes do vencimento.

### Caso o certificado expire ou falhe:
1.  Acesse o painel administrativo: `http://192.168.0.198:81`.
2.  V√° na aba **SSL Certificates**.
3.  Clique nos tr√™s pontos ao lado do dom√≠nio e selecione **Renew Now**.
4.  **Requisito Cr√≠tico:** A porta **80** do seu roteador deve estar aberta e apontando para o servidor Linux para que a valida√ß√£o do Let's Encrypt funcione.

---

## üõ†Ô∏è 3. Troubleshooting (Resolu√ß√£o de Problemas)

### ‚ùå Erro "Internal Error" no Painel NPM
Ocorre quando o Nginx tenta carregar uma configura√ß√£o com erro de sintaxe (geralmente nomes de host com barras ou containers que n√£o est√£o na mesma rede).

**Como destravar:**
1.  Acesse o terminal (PuTTY) e entre no container:
    `docker exec -it supervarejo_teste-proxy sh`.
2.  Navegue at√© a pasta de configura√ß√µes:
    `cd /data/nginx/proxy_host`.
3.  Remova o arquivo que est√° causando o erro (ex: `1.conf` conforme indicado nos logs):
    `rm 1.conf`.
4.  Saia e reinicie o proxy:
    `exit` e `docker restart supervarejo_teste-proxy`.

### ‚ùå Erro "502 Bad Gateway" (API ou ERP)
O Nginx n√£o consegue encontrar o servi√ßo de destino.
* **Verifique os Hostnames:** No painel NPM > Custom Locations, os campos **Forward Hostname** NUNCA devem ter barras (`/`).
    * Para `/api`: Use o nome `api`.
    * Para `/erp`: Use o IP `192.168.0.198` (pois est√° em modo host).

### ‚ùå Erro "500 Internal Server Error" na busca de Produtos
Falha de comunica√ß√£o entre a API ERP e o banco PostgreSQL local.
* **Verifica√ß√£o de IP:** Se o container da API ERP mudar de IP, o PostgreSQL pode bloquear a conex√£o.
* **Corre√ß√£o:** Verifique o arquivo `/etc/postgresql/14/main/pg_hba.conf` e garanta que a linha abaixo esteja presente:
    `host all all 172.20.0.0/16 scram-sha-256`.
* **Reinicie o Banco:** `sudo systemctl restart postgresql`.

---

## üíª 4. Comandos de Emerg√™ncia

| A√ß√£o | Comando |
| :--- | :--- |
| **Ver logs de todos os servi√ßos** | `docker compose logs -f --tail 50` |
| **Verificar se o Banco Local est√° ativo** | `sudo systemctl status postgresql` |
| **Ver IP real de um container** | `docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' supervarejo_teste-erp-ssl` |
| **Recriar ambiente do zero** | `docker compose up -d --build` |

---

## üìù 5. Notas Importantes de Configura√ß√£o
* **Portas:** A porta `3333` (API) e `3334` (ERP) devem ser mantidas como est√£o no arquivo `index.js` do Frontend para evitar erros de refer√™ncia.
* **Docker Host Mode:** N√£o adicione a `api-erp` de volta √† `networks: supervarejo-net` no arquivo compose, ou ela perder√° o acesso ao `127.0.0.1` do banco de dados.